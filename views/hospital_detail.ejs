<!DOCTYPE html>
<html>
<head>
  <title><%= hospital.name %> - Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container mt-4">
    <h2><%= hospital.name %></h2>
    <p>Email: <%= hospital.email %></p>
    <p>Phone: <%= hospital.phone %></p>
    <p>Address: <%= hospital.address %></p>

    <hr>

    <!-- Doctors grouped by category -->
    <h4>Doctors</h4>
    <% 
      const categories = {};
      hospital.doctors.forEach(doc => {
        if (!categories[doc.category]) categories[doc.category] = [];
        categories[doc.category].push(doc);
      });
    %>
    <% Object.keys(categories).forEach(cat => { %>
      <div class="mt-3">
        <h5 class="mb-2"><%= cat %></h5>
        <ul class="list-group mb-3">
          <% categories[cat].forEach(doctor => { %>
            <li class="list-group-item">
              <h6><%= doctor.name %></h6>
              <p>Email: <%= doctor.email %></p>
              
              <!-- OPD Slots -->
              <p>
                <strong>OPD Slots:</strong>
                <% if (doctor.slots && doctor.slots.length > 0) { %>
                  <ul class="list-inline">
                    <% doctor.slots.forEach(slot => { 
                         // Calculate booked and remaining
                         const bookedCount = doctor.bookedSlots?.get(slot) || 0;
                         const remaining = (doctor.slotCapacity || 15) - bookedCount;
                         const isFull = remaining <= 0;
                    %>
                      <li class="list-inline-item mb-2">
                        <% if(!isFull) { %>
                          <a href="/opd/new?hospitalId=<%= hospital._id %>&doctorId=<%= doctor._id %>&slot=<%= slot %>" 
                             class="btn btn-sm btn-primary">
                            <i class="fas fa-calendar-check"></i> Book <%= slot %> (<%= remaining %> left)
                          </a>
                        <% } else { %>
                          <button class="btn btn-sm btn-secondary" disabled>
                            <i class="fas fa-times-circle"></i> Full <%= slot %>
                          </button>
                        <% } %>
                      </li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <span class="text-muted">No OPD slots available</span>
                <% } %>
              </p>

              <!-- Online Slots -->
              <p>
                <strong>Online Slots:</strong>
                <% if (doctor.onlineSlots && doctor.onlineSlots.length > 0) { %>
                  <ul class="list-inline">
                    <% doctor.onlineSlots.forEach(slot => { 
                         const bookedCount = doctor.bookedOnlineSlots?.get(slot) || 0;
                         const remaining = (doctor.onlineSlotCapacity || 15) - bookedCount;
                         const isFull = remaining <= 0;
                    %>
                      <li class="list-inline-item mb-2">
                        <% if(!isFull) { %>
                          <a href="/bookings/new?doctorId=<%= doctor._id %>&slot=<%= slot %>" 
                             class="btn btn-sm btn-success">
                            <i class="fas fa-video"></i> Book <%= slot %> (<%= remaining %> left)
                          </a>
                        <% } else { %>
                          <button class="btn btn-sm btn-secondary" disabled>
                            <i class="fas fa-times-circle"></i> Full <%= slot %>
                          </button>
                        <% } %>
                      </li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <span class="text-muted">No Online slots available</span>
                <% } %>
              </p>
            </li>
          <% }) %>
        </ul>
      </div>
    <% }) %>

    <hr>

    <!-- Rooms -->
    <h4>Room Availability</h4>
    <ul class="list-group mb-3">
      <% hospital.rooms.forEach(room => { %>
        <li class="list-group-item">
          <%= room.type %>: <%= room.available %> / <%= room.total %> available
        </li>
      <% }) %>
    </ul>

    <hr>

    <!-- Ambulance -->
    <h4>Ambulances</h4>
    <p>Total Available: <strong><%= hospital.ambulances %></strong></p>
  </div>
</body>
</html>
