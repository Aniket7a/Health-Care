
<!-- This goes in your main layout file (like views/layouts/boilerplate.ejs) -->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= patient.name %> — Patient Health Dashboard</title>

  <!-- UX4G Design System (frontend-only; safe to include) -->
  <link href="https://cdn.jsdelivr.net/npm/@ux4g/design-system@1.0.0/dist/ux4g.min.css" rel="stylesheet">

  <!-- Bootstrap (kept for your existing layout & components) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <!-- Charts (kept: your analytics visualisations) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Accessibility: prefers-reduced-motion -->
  <style>
    :root{
      --goi-blue:#002F6C;
      --goi-green:#138808;
      --brand-on:#ffffff;
      --muted:#6b7280;
      --bg:#f6f7fb;
      --card:#ffffff;
      --focus:#ffcc33; /* visible focus for WCAG 2.1 AA */
    }
    html:focus-within { scroll-behavior: smooth; }
    body{ background:var(--bg); color:#111827; }
    a:focus, button:focus, [role="button"]:focus, .form-control:focus{
      outline:3px solid var(--focus)!important; outline-offset:2px!important; box-shadow:none!important;
    }

    /* Skip link */
    .skip-link{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
    .skip-link:focus{ position:static; width:auto; height:auto; padding:.5rem 1rem; background:#fff; border:2px solid var(--goi-blue); z-index:10000; }

    /* Header */
    .gov-header{
      background: var(--goi-blue);
      color: var(--brand-on);
    }
    .gov-strip{ background: var(--goi-green); height:6px; }

    /* Shell layout */
    .app-shell{ display:grid; grid-template-columns: 280px 1fr; gap:1.25rem; }
    @media (max-width: 992px){ .app-shell{ grid-template-columns: 1fr; } }

    /* Sidebar */
    .sidebar{
      background: var(--card);
      border:1px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem;
    }
    .sidebar .nav-link{
      color:#111827; border-radius:10px; padding:.6rem .8rem; font-weight:500;
    }
    .sidebar .nav-link:hover,
    .sidebar .nav-link.active{
      background: rgba(0,47,108,.08);
      color: var(--goi-blue);
    }

    /* Cards */
    .card-clean{
      background: var(--card);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
    }
    .card-clean .card-header{
      background: #fff;
      border-bottom: 1px solid #e5e7eb;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }

    /* Stat chips (solid, no fancy gradients) */
    .chip{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.35rem .6rem; border-radius:999px; font-size:.85rem; font-weight:600;
    }
    .chip-blue{ background:#e6eef9; color:#0b4a9e; }
    .chip-green{ background:#e8f5ec; color:#0f7a2d; }
    .chip-amber{ background:#fff3cd; color:#8a6d00; }
    .chip-gray{ background:#f3f4f6; color:#374151; }

    /* Map placeholder */
    .map-ph{
      height: 180px; border:1px dashed #cbd5e1; border-radius:10px;
      display:flex; align-items:center; justify-content:center; color:#6b7280; background:#fafafa;
    }

    /* High-contrast / font-size toggle */
    .accessibility-high-contrast body, body.high-contrast{
      background:#000 !important; color:#fff !important;
    }
    .accessibility-high-contrast .card-clean, body.high-contrast .card-clean{
      background:#111 !important; border-color:#444 !important;
    }
    .fs-large{ font-size: 112.5%; }
    .fs-xlarge{ font-size: 125%; }

    /* Data tables for readability */
    .table thead th{ background:#f8fafc; color:#111827; }
  </style>
</head>

<body>
  <a class="skip-link" href="#main">Skip to main content</a>
  <div class="gov-strip" aria-hidden="true"></div>

  <!-- Header -->
  <header class="gov-header py-3">
    <div class="container-fluid">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3">
          
          <div>
            <h1 class="h4 mb-0">Ayuvaani — Patient Health Dashboard</h1>
            <p class="mb-0 small">Government of India • Ayushman Bharat Digital Mission</p>
          </div>
        </div>

        <div class="text-end">
          
          
          <div class="small">
           
            
              
            
          </div>
        </div>

        <div class="d-flex align-items-center gap-2">
          <!-- Accessibility controls (no external dependency) -->
          <div class="btn-group" role="group" aria-label="Accessibility controls">
            <button type="button" class="btn btn-outline-light btn-sm" id="fontInc" aria-pressed="false">
              A+
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="fontDec" aria-pressed="false">
              A−
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="contrast" aria-pressed="false">
              High Contrast
            </button>
          </div>
          <a href="/logout" class="btn btn-light btn-sm">
            <i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i> Logout
          </a>
        </div>
      </div>
    </div>
  </header>

  <main id="main" class="container-fluid my-4 app-shell">
    <!-- Sidebar -->
    <nav class="sidebar" aria-label="Primary">
      <ul class="nav flex-column gap-1">
        <li class="nav-item">
          <a class="nav-link active" href="/listings">
            <i class="fa-solid fa-house me-2" aria-hidden="true"></i> Home
          </a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link" href="/patients/<%= patient._id %>/history">
            <i class="fa-solid fa-file-medical me-2" aria-hidden="true"></i> My Records
          </a>
        </li>
        
        <li class="nav-item">
          <a class="nav-link" href="/patients/<%= patient._id %>/wellness">
            <i class="fa-solid fa-heart-pulse me-2" aria-hidden="true"></i> Wellness & Preventive Care
          </a>
        </li>
        <li class="nav-item mt-2">
          <span class="text-uppercase small text-muted px-2">Ecosystem</span>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://www.digilocker.gov.in/" aria-label="DigiLocker (placeholder)">
            <i class="fa-solid fa-lock me-2" aria-hidden="true"></i> DigiLocker
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" aria-label="Aadhaar (placeholder)">
            <i class="fa-solid fa-id-card me-2" aria-hidden="true"></i> Aadhaar
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#" aria-label="ABDM MyHealth (placeholder)">
            <i class="fa-solid fa-notes-medical me-2" aria-hidden="true"></i> MyHealth (ABDM)
          </a>
        </li>

        <li class="nav-item mt-3">
          <a class="nav-link" href="/support">
            <i class="fa-solid fa-headset me-2" aria-hidden="true"></i> Support
          </a>
        </li>
      </ul>
    </nav>

    <!-- Main content column -->
    <section class="d-grid gap-3">
      <!-- Summary strip -->
      <div class="card-clean p-3" role="region" aria-labelledby="summaryTitle">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <h2 id="summaryTitle" class="h5 mb-0">Health Summary</h2>
          <div class="d-flex flex-wrap gap-2">
            <span class="chip chip-blue" aria-label="OPD visits">
              <i class="fa-solid fa-hospital" aria-hidden="true"></i>
              <strong><%= stats.totalOPD %></strong> OPD Visits
            </span>
            <span class="chip chip-green" aria-label="Online consultations">
              <i class="fa-solid fa-video" aria-hidden="true"></i>
              <strong><%= stats.totalOnline %></strong> Online Consults
            </span>
            
            <span class="chip chip-gray" aria-label="Total appointments">
              <i class="fa-solid fa-calendar-days" aria-hidden="true"></i>
              <strong><%= analytics.totalAppointments %></strong> Appointments
            </span>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card-clean">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h3 class="h6 mb-0"><i class="fa-solid fa-chart-pie me-2" aria-hidden="true"></i>Consultation Methods</h3>
            </div>
            <div class="card-body">
              <canvas id="consultationChart" role="img" aria-label="Consultation method breakdown chart"></canvas>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card-clean">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h3 class="h6 mb-0"><i class="fa-solid fa-calendar-alt me-2" aria-hidden="true"></i>Visit Frequency Analysis</h3>
            </div>
            <div class="card-body">
              <canvas id="frequencyChart" role="img" aria-label="Visit frequency chart"></canvas>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card-clean">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h3 class="h6 mb-0"><i class="fa-solid fa-chart-line me-2" aria-hidden="true"></i>Monthly Health Activity Trends</h3>
            </div>
            <div class="card-body">
              <canvas id="monthlyTrendsChart" role="img" aria-label="Monthly trends chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Most visited hospitals & Common issues -->
      <div class="row g-3">
        <div class="col-lg-6">
          <div class="card-clean">
            <div class="card-header">
              <h3 class="h6 mb-0"><i class="fa-solid fa-hospital-symbol me-2" aria-hidden="true"></i>Most Visited Hospitals</h3>
            </div>
            <div class="card-body">
              <% if (analytics.hospitalStats?.all?.length) { %>
                <% analytics.hospitalStats.all.slice(0,5).forEach(function(hospital){ %>
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-medium"><%= hospital.name %></span>
                    <span class="text-nowrap">
                      <span class="badge bg-primary"><%= hospital.count %> visits</span>
                      <span class="text-muted ms-1"><%= hospital.percentage %>%</span>
                    </span>
                  </div>
                  <div class="progress mb-2" role="progressbar" aria-valuenow="<%= hospital.percentage %>" aria-valuemin="0" aria-valuemax="100" aria-label="<%= hospital.name %> visit share">
                    <div class="progress-bar" style="width:<%= hospital.percentage %>%"></div>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-muted mb-0">No hospital visits recorded yet.</p>
              <% } %>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card-clean">
            <div class="card-header">
              <h3 class="h6 mb-0"><i class="fa-solid fa-stethoscope me-2" aria-hidden="true"></i>Common Health Issues</h3>
            </div>
            <div class="card-body">
              <% if (analytics.healthIssues?.length) { %>
                <% analytics.healthIssues.forEach(function(issue){ %>
                  <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="fw-medium"><%= issue.issue %></span>
                    <span class="text-nowrap">
                      <span class="badge bg-info text-dark"><%= issue.count %> times</span>
                      <span class="text-muted ms-1"><%= issue.percentage %>%</span>
                    </span>
                  </div>
                  <div class="progress mb-2" role="progressbar" aria-valuenow="<%= issue.percentage %>" aria-valuemin="0" aria-valuemax="100" aria-label="<%= issue.issue %> frequency">
                    <div class="progress-bar bg-info" style="width:<%= issue.percentage %>%"></div>
                  </div>
                <% }) %>
              <% } else { %>
                <p class="text-muted mb-0">No health issues data available.</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activity + Quick Actions -->
      <div class="row g-3">
        <div class="col-lg-8">
          <div class="card-clean">
            <div class="card-header">
              <h3 class="h6 mb-0"><i class="fa-solid fa-clock me-2" aria-hidden="true"></i>Recent Activity</h3>
            </div>
            <div class="card-body">
              <% if ((opdHistory?.length || 0) > 0 || (onlineHistory?.length || 0) > 0) { %>
                <% [...opdHistory.slice(0,3), ...onlineHistory.slice(0,3)]
                    .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt))
                    .slice(0,5)
                    .forEach(function(activity){ %>
                      <div class="d-flex align-items-start mb-3">
                        <div class="me-3 mt-1" aria-hidden="true">
                          <% if (activity.hospitalId) { %>
                            <i class="fa-solid fa-hospital text-primary"></i>
                          <% } else { %>
                            <i class="fa-solid fa-video text-success"></i>
                          <% } %>
                        </div>
                        <div class="flex-grow-1">
                          <div class="fw-semibold">
                            <%= activity.doctorName %>
                            <% if (activity.hospitalId) { %> at <%= activity.hospitalId.name %> <% } else { %>(Online)<% } %>
                          </div>
                          <div class="text-muted small">
                            <%= moment(activity.createdAt).format('MMM DD, YYYY') %>
                            <% if (activity.slotTime) { %> • <%= activity.slotTime %><% } %>
                          </div>
                        </div>
                      </div>
                <% }) %>
              <% } else { %>
                <p class="text-muted mb-0">No recent activity found.</p>
              <% } %>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card-clean">
            <div class="card-header">
              <h3 class="h6 mb-0"><i class="fa-solid fa-bolt me-2" aria-hidden="true"></i>Quick Actions</h3>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <a href="/hospitals" class="btn btn-primary">
                  <i class="fa-solid fa-hospital me-1" aria-hidden="true"></i> Book OPD
                </a>
                <a href="/bookings/new" class="btn btn-success">
                  <i class="fa-solid fa-video me-1" aria-hidden="true"></i> Online Consultation
                </a>
                <a href="/patients/<%= patient._id %>/history" class="btn btn-outline-primary">
                  <i class="fa-solid fa-history me-1" aria-hidden="true"></i> Full History
                </a>
                <a href="/pharmacies" class="btn btn-outline-secondary">
                  <i class="fa-solid fa-pills me-1" aria-hidden="true"></i> Find Medicines
                </a>
              </div>
            </div>
          </div>

          <div class="card-clean mt-3">
            <div class="card-header">
              <h3 class="h6 mb-0"><i class="fa-regular fa-lightbulb me-2" aria-hidden="true"></i>Health Insight</h3>
            </div>
            <div class="card-body">
              <% if (analytics.visitFrequency.frequency === 'High') { %>
                You are actively managing your health with frequent consultations.
              <% } else if (analytics.visitFrequency.frequency === 'Regular') { %>
                You maintain a consistent schedule of care.
              <% } else { %>
                Consider scheduling regular check-ups to maintain optimal health.
              <% } %>
            </div>
          </div>
        </div>
      </div>

      
        
      </div>
    </section>
  </main>

  <footer class="mt-4">
    <div class="container-fluid">
      <div class="card-clean p-3">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
          <div class="d-flex align-items-center gap-2">
            <img src="/assets/emblem.svg" width="24" height="24" alt="" aria-hidden="true" />
            <span class="small">© Government of India • NDHB compliant • ABDM ecosystem ready</span>
          </div>
          <nav aria-label="Footer">
            <a class="small me-3" href="/privacy">Privacy</a>
            <a class="small me-3" href="/terms">Terms</a>
            <a class="small" href="/accessibility">Accessibility</a>
          </nav>
        </div>
      </div>
    </div>
  </footer>

  <!-- Scripts: Bootstrap -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Accessibility controls (local, no backend change) -->
  <script>
    (function(){
      const root = document.documentElement;
      const body = document.body;
      const inc = document.getElementById('fontInc');
      const dec = document.getElementById('fontDec');
      const con = document.getElementById('contrast');

      let scale = 100;
      function applyScale(){ body.style.fontSize = scale + '%'; }

      inc?.addEventListener('click', function(){ scale = Math.min(130, scale + 12.5); applyScale(); this.setAttribute('aria-pressed','true'); dec.setAttribute('aria-pressed','false'); });
      dec?.addEventListener('click', function(){ scale = Math.max(87.5, scale - 12.5); applyScale(); this.setAttribute('aria-pressed','true'); inc.setAttribute('aria-pressed','false'); });
      con?.addEventListener('click', function(){
        const on = body.classList.toggle('high-contrast');
        this.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
    })();
  </script>

  <!-- Charts: keep your existing analytics bindings; colors adjusted for brand -->
  <script>
    // Color palette aligned to brand
    const brandColors = {
      blue: '#002F6C',
      blueTrans: 'rgba(0,47,108,0.15)',
      green: '#138808',
      greenTrans: 'rgba(19,136,8,0.15)',
      gray: 'rgba(17,24,39,0.25)'
    };

    // Consultation Methods Pie/Doughnut
    const consultationData = {
      labels: ['OPD Visits', 'Online Consultations', 'In-Person Visits', 'Scheduled'],
      datasets: [{
        data: [
          <%= analytics.consultationModes.opd %>,
          <%= analytics.consultationModes.online %>,
          <%= analytics.consultationModes.inPerson %>,
          <%= analytics.consultationModes.scheduled %>
        ],
        backgroundColor: [brandColors.blue, brandColors.green, '#14532d', '#64748b'],
        borderColor: '#ffffff',
        borderWidth: 2
      }]
    };
    new Chart(document.getElementById('consultationChart'), {
      type: 'doughnut',
      data: consultationData,
      options: {
        responsive:true,
        plugins:{ legend:{ position:'bottom' } }
      }
    });

    // Visit Frequency Bar
    const frequencyData = {
      labels: ['This Month', 'Last 3 Months', 'Last 6 Months', 'This Year'],
      datasets: [{
        label: 'Number of Visits',
        data: [
          <%= analytics.visitFrequency.thisMonth %>,
          <%= analytics.visitFrequency.last3Months %>,
          <%= analytics.visitFrequency.last6Months %>,
          <%= analytics.visitFrequency.thisYear %>
        ],
        backgroundColor: brandColors.blue,
        borderColor: brandColors.blue,
        borderWidth:1
      }]
    };
    new Chart(document.getElementById('frequencyChart'), {
      type:'bar',
      data: frequencyData,
      options:{
        responsive:true,
        scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } },
        plugins:{ legend:{ display:false } }
      }
    });

    // Monthly Trends Line
    const monthlyLabels = [<% analytics.monthlyTrends.forEach(function(m, i){ %>'<%= m.month %>'<% if(i<analytics.monthlyTrends.length-1){ %>,<% } %><% }) %>];
    const monthlyOPD = [<% analytics.monthlyTrends.forEach(function(m, i){ %><%= m.opd %><% if(i<analytics.monthlyTrends.length-1){ %>,<% } %><% }) %>];
    const monthlyOnline = [<% analytics.monthlyTrends.forEach(function(m, i){ %><%= m.online %><% if(i<analytics.monthlyTrends.length-1){ %>,<% } %><% }) %>];

    new Chart(document.getElementById('monthlyTrendsChart'), {
      type:'line',
      data:{
        labels: monthlyLabels,
        datasets:[
          {
            label:'OPD Visits',
            data: monthlyOPD,
            borderColor: brandColors.blue,
            backgroundColor: brandColors.blueTrans,
            tension:.25,
            fill:true
          },
          {
            label:'Online Consultations',
            data: monthlyOnline,
            borderColor: brandColors.green,
            backgroundColor: brandColors.greenTrans,
            tension:.25,
            fill:true
          }
        ]
      },
      options:{
        responsive:true,
        scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }
      }
    });
  </script>
</body>
</html>
